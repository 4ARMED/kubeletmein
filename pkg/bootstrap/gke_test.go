package bootstrap

import (
	"bytes"
	"io/ioutil"
	"net/http"
	"testing"

	"cloud.google.com/go/compute/metadata"
	"github.com/4armed/kubeletmein/pkg/mocks"
	"github.com/stretchr/testify/assert"
	yaml "gopkg.in/yaml.v2"
)

func TestMetadataFromService(t *testing.T) {

	k := Kubeenv{}

	metadataClient := mocks.NewTestClient(func(req *http.Request) *http.Response {
		assert.Equal(t, "http://169.254.169.254/computeMetadata/v1/instance/attributes/kube-env", req.URL.String(), "should be equal")
		return &http.Response{
			StatusCode: 200,
			Body:       ioutil.NopCloser(bytes.NewBufferString(exampleKubeEnv)),
			Header:     make(http.Header),
		}
	})

	m := metadata.NewClient(metadataClient)
	kubeenv, err := fetchMetadataFromService(m)
	if err != nil {
		t.Errorf("want kubeenv, got %q", err)
	}

	err = yaml.Unmarshal(kubeenv, &k)
	if err != nil {
		t.Errorf("unable to parse YAML from kube-env: %v", err)
	}

	assert.Equal(t, "1.1.1.1", k.KubeMasterName, "they should be equal")

}

func TestMetadataFromFile(t *testing.T) {

}

func TestBootstrapGkeCmd(t *testing.T) {
	// t.Errorf("test failed %s", "meh")

}

var (
	exampleKubeEnv = `CA_CERT: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURLekNDQWhPZ0F3SUJBZ0lSQU5OT1RkS3ZlM1JzZGFHWGR0YlZDTWN3RFFZSktvWklodmNOQVFFTEJRQXcKTHpFdE1Dc0dBMVVFQXhNa01XWm1aREUyTmpjdE5HWTJaQzAwTkRFNExUZzNOR1F0WldVMk0yUTJNVFEwWVdKawpNQjRYRFRJeE1ETXdNakl4TVRNMU5sb1hEVEkyTURNd01USXlNVE0xTmxvd0x6RXRNQ3NHQTFVRUF4TWtNV1ptClpERTJOamN0TkdZMlpDMDBOREU0TFRnM05HUXRaV1UyTTJRMk1UUTBZV0prTUlJQklqQU5CZ2txaGtpRzl3MEIKQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBb3NscUltcEZEaE9BVnMzU0ZFeE9ud1Zkd2V5SEl4TllSazJ2MWUyaQpLUkpUZ3NJTkNYQzBURTNUQlQ1UWgzTkQzdHpJc3k0dHFKcGZkTlQ1WUg0WFJJMVF3R1I5TnpwdHgvNU4vUUlEClRNZ2FDNWpndFMydUQxTEZhcVJFaENUVURieERSUnhDNkxkWkxOeDRCUE9NeU5QblRKYUpuanRmcmZLMTVQZ0IKOU8vZFFrZGhEb2F6S0pXSVVRZFI3K082OEdJUE5hMHZBVEJnVzhmL1FpMUJlaVZNOHhzSG1TN3MyMk1lV0ppegpFSTZESytscXBCN1NTQ0ZwT3FCdFFiUmsyRGJkby9vYlJuSW5peDRZRlFiRW9NZjVjWmpCNUJLbEJLOW42eTFKClRWTHBhRFpsc09mcFN0NG8xSzNGNVJyQW9QN3NCbEFPR2ZHKzlFcDhjUDNyYndJREFRQUJvMEl3UURBT0JnTlYKSFE4QkFmOEVCQU1DQWdRd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFRmdRVXJKWkdqb1hTcDR1SApyUFRudm1BS3E2bWRIOVl3RFFZSktvWklodmNOQVFFTEJRQURnZ0VCQUdtU1dkY0pabkN1ekpWN3JyTUEvUXFZCkdQd1ZKT3I3VE00V2cra2RHMy94K1RzQndQcVNlc1FhTmNUYmUzb2VpSGlJVkZaRUVDTHFtKzZNTjM4bDllUVQKSmE3d2kzU1Z5NEc0NkE2NUIyZXZRYkNwWFBReUFLWmp3cWpCdzJVRFhNWkZGMnNTZE9ZOGs5UVZHc2JicXovaAphM05tNVk2L0lkWnVWTjF6bFZHMm1ZOExiKzNGRHRXL3NaSFZZM2wzb2EzQlZoYzFPSFMyZHNQMXU4MWY1d1FCCkFpSmUxN1JGVDB6WXFta3lVS2E5OFQ5cFRlbUNiSXREdjdrbDBLemxCQTlSbnQwMDB2OTdqNWp2ZlFqNU9KcGMKclNpb2pvVjFwbmxFRHJtbkZXQzhmVmVSZGRET01HM0FteFRLWTVJOE1BM21xT1hwM1pFUUl5Z3QvdjJ3blY4PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
KUBELET_CERT: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvRENDQWVTZ0F3SUJBZ0lRVlZCanRFY08rUHdrQ24yc010OUdaakFOQmdrcWhraUc5dzBCQVFzRkFEQXYKTVMwd0t3WURWUVFERXlReFptWmtNVFkyTnkwMFpqWmtMVFEwTVRndE9EYzBaQzFsWlRZelpEWXhORFJoWW1RdwpIaGNOTWpFd016QXlNakl4TXpVM1doY05Nall3TXpBeE1qSXhNelUzV2pBU01SQXdEZ1lEVlFRREV3ZHJkV0psCmJHVjBNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQW0rbC8yTWVNd21DeHU3NUcKQk82d3M1OUZEeDdjeHNRZndIaGJhcEFJWEFoeGt4V29LMzVhamlNM1Z6dC9XcTEzTzhFQ3V0dEUzUElIV2k3YQpWcjZKcXcyVkZzSTVNcG9WTFBqaGN1ZkxQMEtGMFptUDNSTWVpaU1wdEJSMi9uZ3JzUE50TXpHTm9ubDQySHhBClVUNFdubUhmeDhOSW1VcU50WE1pYTRCV0RNUUIwSTJsVzVUbUZidW1GYndIb3cySlN0YStiRFVIRHpQN202YkgKVEhuS0xOSGZQVlF3dE1tbFlqeVhpWWJmMzcwMnRhSlc3UFdPSzhFb0k2dDUxZmpoUC9BeVNvQ2VhMThzNStwRgprd0xVOE9uSE5xYkxIWThjeXhCelhLYlVUOG1FMmVMeHBCR0pTZ3RPeE00MzB5bXZzcWVEM2MzY1JFTk9hZDNXClB6NDYwUUlEQVFBQm96RXdMekFNQmdOVkhSTUJBZjhFQWpBQU1COEdBMVVkSXdRWU1CYUFGS3lXUm82RjBxZUwKaDZ6MDU3NWdDcXVwblIvV01BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQTl0Ny94RWFxSksybEJza2hiZTJCKwpRNUJVMzFmNWdtdFNKbDZWczJuNG1NK1ZXbHBSdHpWMlZuaSs1bTlYVE01cEpHUm5DUmdCR0Y5S2RDa2o2ZXlUCmpyVmh0ak8xVmZrRmtHb3IrNlAwRWZSZkJQSXU0aGlYUzJGQ2lYSGRlSGFHOVhsai9MT2c2RXVrckhOb2ZiZ2IKcTlnYTFJRytmQ2t6NTFjNUFIbXl5NmUrRmdIVnBORGptaGJMMWFaNU9hcVJMczBJS1V3akgvTmJhNGhlMDMzQgovbmNVTmV2VlcwSWlYM3F2SXF2b0pLdkR4eWFVRUNGVW5YbGVMQ2V0cHY4RlI0R21aRlVMdUhsbm0rYTBGU2FkCmkzc1IwYzdidzRnUDRqd1lyRTNDekJ4NWZVY01YcTZEaDB6Sk1kTFVPRFJoYmlEWHZRR0ZIS2NrR2pRc0FXcFYKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
KUBELET_KEY: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb2dJQkFBS0NBUUVBbStsLzJNZU13bUN4dTc1R0JPNndzNTlGRHg3Y3hzUWZ3SGhiYXBBSVhBaHhreFdvCkszNWFqaU0zVnp0L1dxMTNPOEVDdXR0RTNQSUhXaTdhVnI2SnF3MlZGc0k1TXBvVkxQamhjdWZMUDBLRjBabVAKM1JNZWlpTXB0QlIyL25ncnNQTnRNekdOb25sNDJIeEFVVDRXbm1IZng4TkltVXFOdFhNaWE0QldETVFCMEkybApXNVRtRmJ1bUZid0hvdzJKU3RhK2JEVUhEelA3bTZiSFRIbktMTkhmUFZRd3RNbWxZanlYaVliZjM3MDJ0YUpXCjdQV09LOEVvSTZ0NTFmamhQL0F5U29DZWExOHM1K3BGa3dMVThPbkhOcWJMSFk4Y3l4QnpYS2JVVDhtRTJlTHgKcEJHSlNndE94TTQzMHltdnNxZUQzYzNjUkVOT2FkM1dQejQ2MFFJREFRQUJBb0lCQUV3eXJxSm1TRk5aU1pQZApkc0FEWGNXenNkOGxjTFlOOVF5dVpkTXJTSUtlTjgrd05tdm5TVitOTTRkRkUwVmdZTlVKekFsQmo2TENBTGpoCkRDRjM1clY4SW1Db2xLYTM2bUI3MUVkQnBMSXFrMWN3UzBDN0R1SnBOQUVJUFcyNWtuVGRTNEhKRnBVUTgvQXQKcll0bklrdk92cjBWSWw2VXNyUTY3RmdJdFVWd0pKRFNSQklibTQ1Q01SZDlKQk5sR0RTYUVGSVhWbkZob2ptVQpaek5jNVBNdVdMNjNrRDhpY0N4TXo1ZWQyL3lVUHFXeUpteWJCQVV2OEhmQ0xvN2tHdG5PS2FCcnczRkpHMlJNCkx3OHprMnlJeDFJaHFFdUFqRjBIZElGOXI2U3Z4bkcyYnVqZ0xRaE1jNFV4K3pTQ1psVG91NmhsOHNVRlRHQmsKWjQxRkJtY0NnWUVBMEw2THpJQ1N2UVI4SEtHMmxjVXFtWHlhQXlKMWsxVG95S3FTaW1BckF2N2R2YlRaOWw5OAoyTWxJSkVWWTh6cjlyVkVRQzVBQkFSaEU1KzRlOFZiaFp5VnRSTjNMemxobVhscElSKzUway9rNlU2S0ZTM1hvCk1XTG5ENjRUL1NPa1NxUXNRMzhFUmIvODlkQ0tpZGZGb25jYm5Za2owYU11MnFML295cUNIYThDZ1lFQXZ6VWsKNkZxdWFwTjRYSnJvVmNuUXkvSHlONGMrODBPdXR1THBQVWZXcmFKcmZsalh5Q3M2czVFUDhoNHk1QmVJVTJZcgo3b25qN09ielkwTm1KRjA2eUZEdzcwQVNnL2ZHemJQcXVJd2pHWHl1WHFCdGZUdGFaakJuREZyWVlpSWpxT2RrCkNobjdPS0FqeXd3OC9weWErVzJxOGxLVzI1emhGSmRQUDIyZnozOENnWUJ5dnB0b1FiRG51Q1JsTkx1Q0hveXAKTEdZWW5RT1dobEVqcFNmQ2F0U1o0L0dPQzNEWXptcDVYRU9NdEpZTnRmcW1IKzQ2L09DZ2NtL0dNZzNPU2h6RApMejZlWVhGYnJ4b3VlV0JNTWhiaEZGbnNpV1RPTXpUOG1Nbzh3MHIzbG5VRUZyVENNWHJ1d0hkVHhGdXpJK25lCndheHJiMnhDRzNwdzhyS2xSWU9hdndLQmdIaWh5OFk0SitBZmFBbHN4ZllSM0lRL0FlVGNrKytnSE9OUFozMTkKREVrQnRyWEEwV3A5TTR6RWtYM2NaWmtYNjY5S1A1OUFLYWQxMGNvblpKSytxdTVrZW8xSExDZE1OSVhrNDhwSQp4NEExOUVESkVDcTVQb0JJTzB0RktVMUlZcDBXVnp3MFJoWGttcEJwQ1RaTmtVeWFUd2FRNnBKbGVHK29RcHd1CnltdDdBb0dBY1RHWEJJVUE2L3pMTUlwaUVoRXcxNkxVN1lKK2Vyd09PZ3JJc1NvTkg4cnBQYVRDRVBPOUcyV3YKTzVJRktCT2JXUit1ekx0R2lmb0ZPU0VTS0FCU0NzMld6NSt6MUphU2VyODZXL0hYdURMaWg3Y21uYnVsNkUwbgp2a3FDUXFRK1YyMkJGbUtkY0llK3dKTUpObXlnb2F2YXhDTStBaEpSb21ic25peithbDQ9Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
KUBERNETES_MASTER_NAME: 1.1.1.1`
)
